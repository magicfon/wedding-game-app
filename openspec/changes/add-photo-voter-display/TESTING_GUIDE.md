# 照片投票者顯示功能 - 測試指南

## 功能概述

這個功能在照片管理介面中新增了投票者顯示功能。當管理員點擊照片放大查看詳情時，在操作按鈕下方會顯示所有投票給這張照片的 LINE 用戶名稱和大頭貼。

## 測試前準備

### 1. 環境設置

確保環境變數正確設置：

```bash
# 複製環境變數範例
cp env.example .env.local

# 編輯 .env.local 文件，設置正確的 Supabase 配置
# NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
# NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
# SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
```

### 2. 資料庫準備

確保資料庫中有：
- 至少一張照片
- 一些投票記錄
- 對應的用戶資料

## 測試步驟

### 1. 後端 API 測試

#### 測試照片存在且有投票者
```bash
curl -X GET "http://localhost:3000/api/admin/photos/voters?photoId=1" \
  -H "Content-Type: application/json"
```

**預期回應：**
```json
{
  "success": true,
  "data": {
    "photoId": 1,
    "voters": [
      {
        "lineId": "U123...",
        "displayName": "張小明",
        "avatarUrl": "https://..."
      }
    ],
    "totalVoters": 1
  }
}
```

#### 測試照片不存在
```bash
curl -X GET "http://localhost:3000/api/admin/photos/voters?photoId=999" \
  -H "Content-Type: application/json"
```

**預期回應：**
```json
{
  "error": "照片不存在"
}
```

#### 測試無效照片 ID
```bash
curl -X GET "http://localhost:3000/api/admin/photos/voters?photoId=invalid" \
  -H "Content-Type: application/json"
```

**預期回應：**
```json
{
  "error": "無效的照片 ID"
}
```

### 2. 前端 UI 測試

#### 測試場景 1：有投票者的照片
1. 啟動開發服務器：`npm run dev`
2. 瀏覽到 `http://localhost:3000/admin/photos`
3. 點擊一張有投票者的照片
4. 驗證投票者列表正確顯示：
   - 標題顯示 "投票者 (N)"
   - 投票者以網格布局顯示
   - 每個投票者顯示頭像和名稱
   - 響應式布局正常工作

#### 測試場景 2：無投票者的照片
1. 點擊一張沒有投票者的照片
2. 驗證顯示空狀態：
   - 顯示 "尚無投票者" 訊息
   - 顯示說明文字

#### 測試場景 3：載入狀態
1. 快速點擊照片
2. 驗證載入動畫：
   - 顯示骨架屏
   - 顯示載入指示器

#### 測試場景 4：錯誤狀態
1. 模擬網路錯誤（可以暫時斷網）
2. 驗證錯誤處理：
   - 顯示錯誤訊息
   - 提供重試按鈕

#### 測試場景 5：響應式設計
1. 在不同螢幕尺寸下測試：
   - 手機版（< 768px）：2 欄布局
   - 平板版（768px - 1023px）：3 欄布局
   - 桌面版（≥ 1024px）：4 欄布局

#### 測試場景 6：頭像載入失敗
1. 準備一個頭像載入失敗的投票者
2. 驗證預設圖標顯示：
   - 頭像載入失敗時顯示預設用戶圖標
   - 名稱仍然正確顯示

## 效能測試

### 1. API 效能
- 測試大量投票者（50+）的載入時間
- 驗證 API 回應時間 < 500ms

### 2. 前端效能
- 測試大量投票者時的渲染效能
- 檢查記憶體使用情況
- 驗證滾動流暢度

## 安全性測試

### 1. 權限控制
- 確保非管理員無法存取 API
- 驗證未授權請求返回適當錯誤

### 2. 資料保護
- 確保不洩露敏感用戶資訊
- 驗證只顯示必要的用戶資料

## 驗收標準

### 功能驗收
- [ ] 管理員可以查看照片的投票者列表
- [ ] 投票者顯示正確的頭像和名稱
- [ ] 無投票者時顯示適當的空狀態
- [ ] 載入和錯誤狀態正確處理
- [ ] 響應式設計在不同螢幕尺寸下正常工作

### 效能驗收
- [ ] API 回應時間 < 500ms
- [ ] 介面載入流暢無延遲
- [ ] 大量投票者時仍保持良好效能

### 安全驗收
- [ ] 非管理員無法存取投票者資訊
- [ ] 用戶資訊不會洩露給未授權者
- [ ] 符合資料保護要求

## 故障排除

### 常見問題

#### 1. API 返回 "fetch failed" 錯誤
**原因：** 環境變數未正確設置
**解決方案：**
```bash
# 檢查環境變數
echo $NEXT_PUBLIC_SUPABASE_URL
echo $SUPABASE_SERVICE_ROLE_KEY

# 確保 .env.local 文件存在且包含正確值
```

#### 2. 前端顯示 "載入中..." 但從未完成
**原因：** API 請求失敗
**解決方案：**
- 檢查瀏覽器開發者工具的網路面板
- 檢查伺服器日誌
- 驗證環境變數設置

#### 3. 投票者列表不顯示
**原因：** 可能是資料庫中沒有投票記錄
**解決方案：**
- 檢查資料庫中的 `votes` 表
- 確保有投票記錄關聯到測試的照片 ID

## 部署注意事項

1. **環境變數：** 確保生產環境設置正確的 Supabase 配置
2. **資料庫遷移：** 確保生產資料庫包含必要的投票記錄
3. **權限設定：** 確保生產環境的 RLS 政策正確配置
4. **效能監控：** 設置適當的監控來追蹤 API 效能

## 聯絡資訊

如果遇到問題，請檢查：
1. 開發者工具的控制台日誌
2. 網路面板的請求和回應
3. Supabase 連接狀態
4. 資料庫查詢執行計畫