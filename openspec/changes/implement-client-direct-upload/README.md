# 實現客戶端直接上傳功能 - 變更提案

## 概述

本變更提案旨在實現客戶端直接上傳到 Supabase Storage 的功能，以移除當前由 Vercel Serverless Function 造成的 5MB 檔案大小限制，支持用戶上傳任意大小的照片。

## 問題陳述

當前的照片上傳系統通過 Vercel Serverless Function 作為代理，將檔案從客戶端傳送到 Supabase Storage。這種方法受到 Vercel 的 4.5MB（實際約 5MB）請求體大小限制，無法處理更大的檔案，限制了用戶上傳高解析度照片的能力。

## 解決方案

### 核心變更

1. **客戶端直接上傳**：使用 Supabase JavaScript SDK 讓客戶端直接上傳檔案到 Supabase Storage，繞過 Vercel 的檔案大小限制。

2. **Resumable Upload**：對於超過 6MB 的大檔案，使用基於 Tus 協議的 Resumable Upload，提高網路不穩定時的上傳成功率。

3. **元數據處理**：上傳完成後，客戶端發送檔案元數據（URL、檔名、大小等）給後端 API 進行資料庫記錄。

4. **保持用戶體驗**：維持現有的上傳進度顯示、錯誤處理和用戶介面。

### 技術架構

- **小檔案 (<6MB)**：直接上傳到 Supabase Storage
- **大檔案 (>=6MB)**：使用 Resumable Upload
- **安全性**：使用 Supabase RLS (Row Level Security) 政策控制存取權限
- **認證**：使用現有的用戶認證系統

## 實施計劃

### 階段 1：基礎設施
- 實現客戶端直接上傳工具函數
- 更新上傳進度庫支援直接上傳
- 修改後端 API 為只處理元數據

### 階段 2：前端整合
- 更新前端組件使用新的上傳方式
- 移除檔案大小限制提示
- 添加大檔案上傳的用戶提示

### 階段 3：測試和驗證
- 測試各種大小的檔案上傳
- 驗證錯誤處理和恢復機制
- 性能測試和優化

### 階段 4：文檔和部署
- 更新使用說明和開發者文檔
- 部署到生產環境
- 監控上傳成功率

## 預期效益

1. **移除檔案大小限制**：用戶可以上傳任意大小的照片
2. **提高上傳成功率**：特別是對於大檔案和網路不穩定的情況
3. **改善用戶體驗**：更快的上傳速度和更好的錯誤處理
4. **降低伺服器負載**：減少 Vercel Function 的頻寬使用

## 風險和緩解措施

1. **安全風險**：使用 Supabase RLS 政策控制存取權限
2. **客戶端複雜度**：提供詳細的文檔和錯誤處理
3. **網路問題**：實現重試機制和恢復功能

## 檔案結構

```
openspec/changes/implement-client-direct-upload/
├── README.md                    # 本文件
├── proposal.md                  # 變更提案
├── design.md                    # 技術設計
├── architecture-diagram.md       # 架構圖和流程
├── tasks.md                     # 實施任務清單
└── specs/
    └── photo-upload/
        └── spec.md              # 規格變更
```

## 審核清單

- [x] 變更提案完整且清晰
- [x] 技術設計考慮了所有關鍵方面
- [x] 實施計劃具體且可執行
- [x] 規格變更涵蓋了所有必要場景
- [x] 風險評估和緩解措施充分
- [x] 架構圖清晰展示了變更前後的差異

## 下一步

1. 請求變更提案審核
2. 獲得批准後開始實施
3. 按照任務清單逐步完成各項工作
4. 定期更新進度和報告問題

---

*本變更提案遵循 OpenSpec 規範創建，確保變更過程的透明度和可追蹤性。*