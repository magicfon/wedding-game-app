# OpenSpec 工作流程指南

## 概述

OpenSpec 是一個規格驅動開發框架，幫助團隊在開發前明確需求、設計和實現計劃。本指南將說明如何在婚禮互動遊戲系統項目中使用 OpenSpec 進行協作開發。

## 三階段工作流程

### 階段 1: 創建變更提案

#### 何時需要創建提案
- 添加新功能或功能模組
- 進行破壞性變更（API、資料庫結構）
- 改變架構或設計模式
- 優化效能（影響行為的變更）
- 更新安全模式

#### 何時不需要提案
- 錯誤修復（恢復預期行為）
- 拼寫錯誤、格式化、註解
- 非破壞性的依賴更新
- 配置變更
- 現有行為的測試

#### 創建提案步驟

1. **檢查現有規格**
   ```bash
   openspec list                    # 查看進行中的變更
   openspec list --specs            # 查看現有功能規格
   openspec spec list --long        # 詳細列出所有規格
   ```

2. **選擇唯一的變更 ID**
   - 使用 kebab-case 格式
   - 以動詞開頭：`add-`, `update-`, `remove-`, `refactor-`
   - 範例：`add-game-sound-effects`, `update-photo-upload-flow`

3. **建立提案結構**
   ```
   openspec/changes/[change-id]/
   ├── proposal.md     # 為什麼要做、做什麼、影響範圍
   ├── tasks.md        # 實現檢查清單
   ├── design.md       # 技術決策（可選）
   └── specs/          # 規格變更
       ├── [capability]/
       │   └── spec.md
   ```

4. **撰寫規格變更**
   - 使用 `## ADDED|MODIFIED|REMOVED Requirements` 格式
   - 每個需求至少包含一個 `#### Scenario:`
   - 場景格式必須使用 `#### Scenario:`（4個井字號）

5. **驗證提案**
   ```bash
   openspec validate [change-id] --strict
   ```

#### 提案範例結構

**proposal.md**
```markdown
## Why
[1-2 句話說明問題或機會]

## What Changes
- [變更列表]
- [標記破壞性變更為 **BREAKING**]

## Impact
- Affected specs: [受影響的功能列表]
- Affected code: [關鍵檔案或系統]
```

**tasks.md**
```markdown
## 1. 實現
- [ ] 1.1 建立資料庫結構
- [ ] 1.2 實現 API 端點
- [ ] 1.3 添加前端組件
- [ ] 1.4 撰寫測試
```

**規格變更格式**
```markdown
## ADDED Requirements
### Requirement: 新功能名稱
系統 SHALL [功能描述]

#### Scenario: 成功案例
- **WHEN** [觸發條件]
- **THEN** [預期結果]
- **AND** [附加條件]
```

### 階段 2: 實現變更

#### 實現前準備
1. **閱讀提案文檔** - 理解要構建什麼
2. **檢視設計文檔** - 審查技術決策（如果存在）
3. **檢視任務清單** - 獲取實現檢查清單
4. **確認提案已批准** - 不要在批准前開始實現

#### 實現步驟
1. 按照順序完成 `tasks.md` 中的每個任務
2. 每完成一個任務，更新其狀態為 `- [x]`
3. 確保所有任務都完成後，更新整個清單為完成狀態
4. 進行測試確保功能正常運作

#### 實現期間注意事項
- 遵循 `openspec/project.md` 中的編碼約定
- 參考現有功能的實現模式
- 保持與現有代碼庫的一致性
- 及時處理實現過程中發現的問題

### 階段 3: 歸檔變更

#### 部署後歸檔
1. **移動變更到歸檔目錄**
   ```bash
   # 手動移動或使用工具
   mv openspec/changes/[name]/ openspec/changes/archive/YYYY-MM-DD-[name]/
   ```

2. **更新主規格**（如果功能有變更）
   ```bash
   # 更新 specs/ 目錄中的主規格檔案
   ```

3. **使用工具歸檔**
   ```bash
   openspec archive [change] --skip-specs --yes  # 僅工具變更
   openspec archive [change] --yes               # 包含規格更新
   ```

4. **驗證歸檔**
   ```bash
   openspec validate --strict  # 確認歸檔的變更通過檢查
   ```

## 專案特定指南

### 婚禮互動遊戲系統的約定

#### 功能命名
- 使用動詞-名詞格式：`user-auth`, `photo-upload`, `quiz-scoring`
- 每個功能應該有單一明確的目的
- 遵循 10 分鐘理解原則：其他人應能在 10 分鐘內理解功能

#### 變更 ID 命名
- 使用 kebab-case，簡短且描述性：`add-two-factor-auth`
- 優先使用動詞前綴：`add-`, `update-`, `remove-`, `refactor-`
- 確保唯一性；如果已被使用，附加 `-2`, `-3` 等

#### 程式碼引用格式
- 檔案位置：`file.ts:42`
- 規格引用：`specs/auth/spec.md`
- 相關變更和 PR 的連結

### 常見工作流程場景

#### 添加新功能
1. 檢查是否已有類似功能規格
2. 創建新的變更提案
3. 撰寫完整的規格和場景
4. 等待批准後開始實現
5. 實現完成後進行測試
6. 部署後歸檔變更

#### 修改現有功能
1. 找到相關的現有規格
2. 創建變更提案，使用 `## MODIFIED Requirements`
3. 包含完整的更新後需求內容
4. 實現變更並更新測試
5. 部署後歸檔並更新主規格

#### 修復錯誤
1. 如果是恢復預期行為，直接修復
2. 如果需要行為變更，創建提案
3. 在提案中清楚說明錯誤和修復方案

## 協作最佳實踐

### 團隊協作
- **提案審查**: 所有變更提案都應經過團隊審查
- **規格討論**: 使用 GitHub Issues 或團隊會議討論規格細節
- **實現協調**: 大型變更應協調多人實現，避免衝突
- **知識分享**: 定期分享實現經驗和最佳實踐

### 品質保證
- **嚴格驗證**: 始終使用 `--strict` 標誌進行驗證
- **測試覆蓋**: 確保新功能有適當的測試覆蓋
- **文件更新**: 保持規格和實現的同步
- **效能監控**: 監控變更對系統效能的影響

### 持續改進
- **回顧機制**: 定期回顧已完成變更的質量和影響
- **流程優化**: 根據團隊經驗優化工作流程
- **工具改進**: 評估和採用新的開發工具和技術
- **知識庫建設**: 建立和維護團隊知識庫

## 故障排除

### 常見錯誤和解決方案

#### "Change must have at least one delta"
- 檢查 `changes/[name]/specs/` 目錄是否存在且包含 .md 檔案
- 確認檔案有操作前綴（## ADDED Requirements）

#### "Requirement must have at least one scenario"
- 檢查場景是否使用 `#### Scenario:` 格式（4個井字號）
- 不要使用項目符號或粗體標示場景標題

#### 驗證失敗
- 使用 `--strict` 模式進行全面檢查
- 檢查 JSON 輸出獲取詳細錯誤信息
- 確認規格檔案格式正確

### 獲取幫助
- 查閱 `openspec/AGENTS.md` 獲取詳細指令
- 使用 `openspec show [item] --json` 獲取詳細信息
- 檢查現有變更的範例作為參考
- 聯繫團隊成員進行協作解決

## 總結

OpenSpec 工作流程幫助團隊：
- **明確需求**：在開發前清楚定義要做什麼
- **統一標準**：使用一致的格式和約定
- **追蹤進度**：清楚記錄變更狀態和實現進度
- **品質保證**：通過驗證確保規格品質
- **知識沉澱**：建立可重用的規格和設計知識庫

通過遵循這個工作流程，團隊可以更高效地協作開發，減少誤解和重複工作，提高軟體開發的整體品質和可維護性。