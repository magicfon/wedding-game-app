# ç…§ç‰‡æ‘¸å½©åŠŸèƒ½éƒ¨ç½²æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç…§ç‰‡æ‘¸å½©ç³»çµ±å…è¨±ç®¡ç†å“¡å¾ä¸Šå‚³è‡³å°‘ 1 å¼µå…¬é–‹ç…§ç‰‡çš„ç”¨æˆ¶ä¸­éš¨æ©ŸæŠ½çï¼Œä¸¦åœ¨å¤§è¢å¹•ä¸Šå±•ç¤ºä¸­çè€…è³‡è¨Šã€‚

### æ ¸å¿ƒåŠŸèƒ½
- âœ… è‡ªå‹•æª¢æ¸¬ç¬¦åˆè³‡æ ¼ç”¨æˆ¶ï¼ˆè‡³å°‘ 1 å¼µå…¬é–‹ç…§ç‰‡ï¼‰
- âœ… åŠ å¯†å®‰å…¨çš„éš¨æ©ŸæŠ½çæ¼”ç®—æ³•
- âœ… å€’æ•¸è¨ˆæ™‚å‹•ç•«ï¼ˆ5 ç§’ï¼‰
- âœ… å¤§è¢å¹•å±•ç¤ºé é¢ï¼ˆé©åˆæŠ•å½±ï¼‰
- âœ… æŠ½çæ­·å²è¨˜éŒ„
- âœ… å³æ™‚æ›´æ–°ï¼ˆSupabase Realtimeï¼‰
- âœ… é˜²ä½œå¼Šæ©Ÿåˆ¶ï¼ˆè¨˜éŒ„åƒèˆ‡è€…å¿«ç…§ï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå»ºç«‹è³‡æ–™åº«è¡¨

åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œä»¥ä¸‹è…³æœ¬ï¼š

```bash
database/create-lottery-tables.sql
```

é€™æœƒå‰µå»ºï¼š
- `lottery_history` - æŠ½çæ­·å²è¨˜éŒ„è¡¨
- `lottery_state` - æŠ½çç‹€æ…‹æ§åˆ¶è¡¨
- `get_lottery_eligible_users()` - æŸ¥è©¢ç¬¦åˆè³‡æ ¼ç”¨æˆ¶çš„å‡½æ•¸
- RLS æ”¿ç­–
- Realtime è§¸ç™¼å™¨

### æ­¥é©Ÿ 2ï¼šå•Ÿç”¨ Supabase Realtime

ç¢ºä¿åœ¨ Supabase æ§åˆ¶å°ä¸­å•Ÿç”¨ä»¥ä¸‹è¡¨çš„ Realtimeï¼š

1. é€²å…¥ Supabase æ§åˆ¶å° â†’ Database â†’ Replication
2. å•Ÿç”¨ä»¥ä¸‹è¡¨ï¼š
   - âœ… `lottery_state`
   - âœ… `lottery_history`

### æ­¥é©Ÿ 3ï¼šéƒ¨ç½²åˆ° Vercel

å¦‚æœæ‚¨å·²ç¶“æœ‰ç¾æœ‰çš„éƒ¨ç½²ï¼Œåªéœ€æ¨é€ä»£ç¢¼ï¼š

```bash
git add .
git commit -m "æ·»åŠ ç…§ç‰‡æ‘¸å½©åŠŸèƒ½"
git push
```

Vercel æœƒè‡ªå‹•é‡æ–°éƒ¨ç½²ã€‚

### æ­¥é©Ÿ 4ï¼šæ¸¬è©¦åŠŸèƒ½

1. **æ¸¬è©¦è³‡æ–™æº–å‚™**
   - ç¢ºä¿è‡³å°‘æœ‰ 1 ä½ç”¨æˆ¶ä¸Šå‚³äº†å…¬é–‹ç…§ç‰‡
   - åœ¨ç®¡ç†å“¡æ§åˆ¶å°ç¢ºèªç”¨æˆ¶åˆ—è¡¨

2. **ç®¡ç†å“¡æ“ä½œ**
   - è¨ªå• `/admin/lottery`
   - æŸ¥çœ‹ç¬¦åˆè³‡æ ¼çš„ç”¨æˆ¶åˆ—è¡¨
   - é»æ“Šã€Œé–‹å§‹æŠ½çã€æŒ‰éˆ•

3. **å¤§è¢å¹•å±•ç¤º**
   - æŠ½çæ™‚æœƒè‡ªå‹•é–‹å•Ÿæ–°è¦–çª—
   - ä¹Ÿå¯ä»¥æ‰‹å‹•è¨ªå• `/lottery-live`
   - å»ºè­°å…¨è¢å¹•é¡¯ç¤ºï¼ˆF11ï¼‰

---

## ğŸ“± ä½¿ç”¨æŒ‡å—

### ç®¡ç†å“¡ç«¯ (`/admin/lottery`)

#### ä¸»è¦åŠŸèƒ½

1. **ç¬¦åˆè³‡æ ¼ç”¨æˆ¶åˆ—è¡¨**
   - é¡¯ç¤ºæ‰€æœ‰ä¸Šå‚³è‡³å°‘ 1 å¼µå…¬é–‹ç…§ç‰‡çš„ç”¨æˆ¶
   - å³æ™‚æ›´æ–°ç”¨æˆ¶è³‡è¨Š

2. **é–‹å§‹æŠ½çæŒ‰éˆ•**
   - åŸ·è¡Œéš¨æ©ŸæŠ½ç
   - è‡ªå‹•é–‹å•Ÿå¤§è¢å¹•é¡¯ç¤º
   - è¨˜éŒ„æŠ½ççµæœ

3. **æŠ½çæ¨¡å¼é–‹é—œ**
   - æ§åˆ¶æŠ½çæ¨¡å¼çš„å•Ÿç”¨/åœç”¨
   - å½±éŸ¿å¤§è¢å¹•é¡¯ç¤ºç‹€æ…‹

4. **é‡ç½®ç‹€æ…‹**
   - æ¸…é™¤ç•¶å‰æŠ½çè¨˜éŒ„
   - æº–å‚™ä¸‹ä¸€è¼ªæŠ½ç

5. **æŠ½çæ­·å²**
   - æŸ¥çœ‹æ‰€æœ‰æŠ½çè¨˜éŒ„
   - æ”¯æ´åˆªé™¤è¨˜éŒ„

#### æ“ä½œæµç¨‹

```
1. é»æ“Šã€ŒæŠ½çæ¨¡å¼ï¼šé—œé–‰ã€â†’ å•Ÿå‹•æŠ½çæ¨¡å¼
2. ç¢ºèªç¬¦åˆè³‡æ ¼ç”¨æˆ¶åˆ—è¡¨
3. é»æ“Šã€Œé–‹å§‹æŠ½çã€
4. ç­‰å¾… 5 ç§’å€’æ•¸
5. å¤§è¢å¹•é¡¯ç¤ºä¸­çè€…
6. é‡è¤‡æŠ½çæˆ–é‡ç½®ç‹€æ…‹
```

### å¤§è¢å¹•å±•ç¤º (`/lottery-live`)

#### é¡¯ç¤ºéšæ®µ

1. **å¾…æ©Ÿéšæ®µ**
   - é¡¯ç¤ºã€Œç­‰å¾…é–‹å§‹æŠ½ç...ã€
   - èƒŒæ™¯ç‚ºæ·¡è‰²æ¼¸å±¤

2. **å€’æ•¸éšæ®µ**
   - 5 ç§’å€’æ•¸è¨ˆæ™‚
   - èƒŒæ™¯å‹•ç•«æ•ˆæœ
   - å¢åŠ ç·Šå¼µæ„Ÿ

3. **ä¸­çè€…å±•ç¤º**
   - é¡¯ç¤ºä¸­çè€…é ­åƒã€åç¨±
   - é¡¯ç¤ºç…§ç‰‡æ•¸é‡ã€åƒèˆ‡äººæ•¸
   - æ…¶ç¥å‹•ç•«ï¼ˆå½©ç´™é£›èˆï¼‰
   - æŒçºŒé¡¯ç¤ºç›´åˆ°ä¸‹æ¬¡æŠ½ç

#### å»ºè­°è¨­å®š

- **è§£æåº¦**ï¼š1920x1080ï¼ˆFull HDï¼‰
- **ç€è¦½å™¨**ï¼šChromeã€Edgeï¼ˆæœ€ä½³æ•ˆæœï¼‰
- **é¡¯ç¤ºæ¨¡å¼**ï¼šå…¨è¢å¹•ï¼ˆæŒ‰ F11ï¼‰
- **ä½ç½®**ï¼šä¸»æœƒå ´å¤§è¢å¹•æŠ•å½±

---

## ğŸ¯ API è·¯ç”±èªªæ˜

### 1. æª¢æŸ¥ç¬¦åˆè³‡æ ¼ç”¨æˆ¶

```
GET /api/lottery/check-eligibility
```

**å›æ‡‰ç¯„ä¾‹ï¼š**
```json
{
  "success": true,
  "eligible_users": [
    {
      "line_id": "U123456",
      "display_name": "å¼µå°è¯",
      "avatar_url": "https://...",
      "photo_count": 3
    }
  ],
  "count": 1
}
```

### 2. åŸ·è¡ŒæŠ½ç

```
POST /api/lottery/draw
Content-Type: application/json

{
  "admin_id": "U789012",
  "admin_name": "ç®¡ç†å“¡",
  "notes": "ç¬¬ä¸€è¼ªæŠ½ç"
}
```

**å›æ‡‰ç¯„ä¾‹ï¼š**
```json
{
  "success": true,
  "winner": {
    "line_id": "U123456",
    "display_name": "å¼µå°è¯",
    "avatar_url": "https://...",
    "photo_count": 3
  },
  "lottery_id": 1,
  "draw_time": "2024-10-04T12:00:00Z",
  "participants_count": 10,
  "message": "ğŸ‰ æ­å–œ å¼µå°è¯ ä¸­çï¼"
}
```

### 3. ç²å–æŠ½çæ­·å²

```
GET /api/lottery/history?limit=20&offset=0
```

### 4. æ§åˆ¶æŠ½çç‹€æ…‹

```
# ç²å–ç‹€æ…‹
GET /api/lottery/control

# å•Ÿç”¨/åœç”¨æŠ½çæ¨¡å¼
POST /api/lottery/control
Content-Type: application/json
{
  "is_lottery_active": true,
  "admin_id": "U789012"
}

# é‡ç½®ç‹€æ…‹
PUT /api/lottery/control
Content-Type: application/json
{
  "admin_id": "U789012"
}
```

---

## ğŸ” å®‰å…¨æ€§æ©Ÿåˆ¶

### 1. é˜²ä½œå¼Šè¨­è¨ˆ

- **åƒèˆ‡è€…å¿«ç…§**ï¼šæ¯æ¬¡æŠ½çéƒ½è¨˜éŒ„ç•¶ä¸‹æ‰€æœ‰ç¬¦åˆè³‡æ ¼çš„ç”¨æˆ¶
- **æ¬Šé‡ç›¸ç­‰**ï¼šä¸è«–ç…§ç‰‡æ•¸é‡ï¼Œæ¯ä½ç”¨æˆ¶ä¸­çæ©Ÿç‡ç›¸åŒ
- **åŠ å¯†éš¨æ©Ÿ**ï¼šä½¿ç”¨ `Math.random()` ç”Ÿæˆéš¨æ©Ÿæ•¸
- **æ“ä½œè¨˜éŒ„**ï¼šè¨˜éŒ„ç®¡ç†å“¡ ID å’Œåç¨±

### 2. è³‡æ–™å®Œæ•´æ€§

- **å¤–éµç´„æŸ**ï¼šç¢ºä¿è³‡æ–™é—œè¯æ­£ç¢º
- **è§¸ç™¼å™¨**ï¼šè‡ªå‹•åŒæ­¥ç‹€æ…‹è®Šæ›´
- **Realtime**ï¼šå³æ™‚æ›´æ–°å‰ç«¯é¡¯ç¤º

### 3. æ¬Šé™æ§åˆ¶

- **RLS æ”¿ç­–**ï¼š
  - æ‰€æœ‰äººå¯æŸ¥çœ‹æŠ½çæ­·å²
  - åªæœ‰ç®¡ç†å“¡å¯åŸ·è¡ŒæŠ½ç
  - åªæœ‰ç®¡ç†å“¡å¯åˆªé™¤è¨˜éŒ„

---

## ğŸ› æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šæ²’æœ‰ç¬¦åˆè³‡æ ¼çš„ç”¨æˆ¶

**åŸå› **ï¼š
- æ²’æœ‰ç”¨æˆ¶ä¸Šå‚³å…¬é–‹ç…§ç‰‡
- æ‰€æœ‰ç…§ç‰‡éƒ½è¨­ç‚ºç§äºº

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```sql
-- æª¢æŸ¥å…¬é–‹ç…§ç‰‡æ•¸é‡
SELECT uploader_line_id, COUNT(*) 
FROM photos 
WHERE is_public = TRUE 
GROUP BY uploader_line_id;
```

### å•é¡Œ 2ï¼šå¤§è¢å¹•é¡¯ç¤ºä¸æ›´æ–°

**åŸå› **ï¼š
- Realtime æœªå•Ÿç”¨
- ç€è¦½å™¨ä¸æ”¯æ´ WebSocket

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ Supabase Realtime è¨­å®š
2. åˆ·æ–°é é¢ï¼ˆF5ï¼‰
3. ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨

### å•é¡Œ 3ï¼šæŠ½çæŒ‰éˆ•ç„¡æ³•é»æ“Š

**åŸå› **ï¼š
- æ­£åœ¨æŠ½çä¸­
- æ²’æœ‰ç¬¦åˆè³‡æ ¼çš„ç”¨æˆ¶
- ç¶²è·¯å»¶é²

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç­‰å¾…ç•¶å‰æŠ½çå®Œæˆ
2. é»æ“Šã€Œé‡ç½®ç‹€æ…‹ã€
3. åˆ·æ–°é é¢

### å•é¡Œ 4ï¼šAPI å›æ‡‰éŒ¯èª¤

**æª¢æŸ¥æ­¥é©Ÿ**ï¼š
```bash
# 1. æª¢æŸ¥è³‡æ–™åº«è¡¨æ˜¯å¦å­˜åœ¨
SELECT table_name FROM information_schema.tables 
WHERE table_name IN ('lottery_history', 'lottery_state');

# 2. æª¢æŸ¥å‡½æ•¸æ˜¯å¦å­˜åœ¨
SELECT * FROM get_lottery_eligible_users();

# 3. æª¢æŸ¥ RLS æ”¿ç­–
SELECT * FROM pg_policies 
WHERE tablename IN ('lottery_history', 'lottery_state');
```

---

## ğŸ“Š è³‡æ–™åº«çµæ§‹

### lottery_history è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | SERIAL | ä¸»éµ |
| winner_line_id | VARCHAR(255) | ä¸­çè€… Line ID |
| winner_display_name | VARCHAR(255) | ä¸­çè€…åç¨± |
| winner_avatar_url | TEXT | ä¸­çè€…é ­åƒ |
| photo_count | INTEGER | ä¸­çè€…ç…§ç‰‡æ•¸ |
| draw_time | TIMESTAMP | æŠ½çæ™‚é–“ |
| admin_id | VARCHAR(255) | ç®¡ç†å“¡ ID |
| admin_name | VARCHAR(255) | ç®¡ç†å“¡åç¨± |
| participants_count | INTEGER | åƒèˆ‡äººæ•¸ |
| participants_snapshot | JSONB | åƒèˆ‡è€…å¿«ç…§ |
| notes | TEXT | å‚™è¨» |

### lottery_state è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | SERIAL | ä¸»éµ |
| is_lottery_active | BOOLEAN | æ˜¯å¦å•Ÿç”¨æŠ½çæ¨¡å¼ |
| is_drawing | BOOLEAN | æ˜¯å¦æ­£åœ¨æŠ½çä¸­ |
| current_draw_id | INTEGER | ç•¶å‰æŠ½ç ID |
| draw_started_at | TIMESTAMP | æŠ½çé–‹å§‹æ™‚é–“ |
| updated_at | TIMESTAMP | æ›´æ–°æ™‚é–“ |

---

## ğŸ¨ è‡ªè¨‚è¨­å®š

### ä¿®æ”¹å€’æ•¸æ™‚é–“

ç·¨è¼¯ `/app/lottery-live/page.tsx`ï¼š

```typescript
const [countdown, setCountdown] = useState(5) // æ”¹ç‚ºå…¶ä»–ç§’æ•¸
```

### ä¿®æ”¹æ…¶ç¥å‹•ç•«æŒçºŒæ™‚é–“

ç·¨è¼¯ `/app/lottery-live/page.tsx`ï¼š

```typescript
setTimeout(() => {
  setCelebrating(false)
}, 5000) // æ”¹ç‚ºå…¶ä»–æ¯«ç§’æ•¸
```

### ä¿®æ”¹æŠ½çæ­·å²é¡¯ç¤ºæ•¸é‡

ç·¨è¼¯ `/app/admin/lottery/page.tsx`ï¼š

```typescript
const response = await fetch('/api/lottery/history?limit=20') // æ”¹ç‚ºå…¶ä»–æ•¸é‡
```

---

## ğŸ“ˆ çµ±è¨ˆè³‡æ–™

### æŸ¥è©¢å¸¸ç”¨çµ±è¨ˆ

```sql
-- ç¸½æŠ½çæ¬¡æ•¸
SELECT COUNT(*) FROM lottery_history;

-- æ¯ä½ä¸­çè€…çš„ä¸­çæ¬¡æ•¸
SELECT winner_display_name, COUNT(*) as win_count
FROM lottery_history
GROUP BY winner_display_name
ORDER BY win_count DESC;

-- å¹³å‡åƒèˆ‡äººæ•¸
SELECT AVG(participants_count) FROM lottery_history;

-- æœ€è¿‘ 10 æ¬¡æŠ½ç
SELECT * FROM lottery_history
ORDER BY draw_time DESC
LIMIT 10;
```

---

## âœ… åŠŸèƒ½æ¸…å–®

- [x] è³‡æ–™åº«è¡¨å»ºç«‹
- [x] API è·¯ç”±å¯¦ä½œ
- [x] ç®¡ç†å“¡æ§åˆ¶é é¢
- [x] å¤§è¢å¹•å±•ç¤ºé é¢
- [x] Realtime å³æ™‚æ›´æ–°
- [x] å€’æ•¸è¨ˆæ™‚å‹•ç•«
- [x] æ…¶ç¥æ•ˆæœå‹•ç•«
- [x] æŠ½çæ­·å²è¨˜éŒ„
- [x] é˜²ä½œå¼Šæ©Ÿåˆ¶
- [x] RLS æ¬Šé™æ§åˆ¶

---

## ğŸ‰ å®Œæˆï¼

ç…§ç‰‡æ‘¸å½©åŠŸèƒ½å·²ç¶“å®Œå…¨éƒ¨ç½²å®Œæˆã€‚å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åƒè€ƒæ•…éšœæ’é™¤ç« ç¯€æˆ–æª¢æŸ¥ Supabase æ—¥èªŒã€‚

ç¥æ‚¨çš„å©šç¦®æ´»å‹•åœ“æ»¿æˆåŠŸï¼ğŸŠ

